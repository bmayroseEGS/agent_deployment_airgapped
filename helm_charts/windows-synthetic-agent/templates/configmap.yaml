apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "windows-synthetic-agent.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "windows-synthetic-agent.labels" . | nindent 4 }}
data:
  agent.yml: |
    {{- if .Values.fleet.enabled }}
    # Fleet-managed mode
    fleet:
      enabled: true
      url: ${FLEET_URL}
      enrollment_token: ${FLEET_ENROLLMENT_TOKEN}
      insecure: ${FLEET_INSECURE}
    {{- else }}
    # Standalone mode - configured to read synthetic Windows logs
    outputs:
      default:
        type: elasticsearch
        hosts:
          - ${ELASTICSEARCH_HOST}
        username: ${ELASTICSEARCH_USERNAME}
        password: ${ELASTICSEARCH_PASSWORD}
        {{- if .Values.elasticsearch.ssl.enabled }}
        ssl:
          enabled: true
          verification_mode: {{ .Values.elasticsearch.ssl.verificationMode }}
        {{- end }}

    inputs:
      - type: filestream
        id: {{ .Values.agentConfig.filestream.id }}
        data_stream:
          type: {{ .Values.agentConfig.dataStream.type }}
          dataset: {{ .Values.agentConfig.dataStream.dataset }}
          namespace: {{ .Values.agentConfig.dataStream.namespace }}
        use_output: default
        paths:
          {{- range .Values.agentConfig.filestream.paths }}
          - {{ . | quote }}
          {{- end }}
        prospector:
          scanner:
            check_interval: {{ .Values.agentConfig.filestream.prospector.scanner.check_interval }}
        parsers:
          - ndjson:
              keys_under_root: true
              overwrite_keys: true
              add_error_key: true
        processors:
          - add_fields:
              target: ""
              fields:
                data_stream.type: {{ .Values.agentConfig.dataStream.type }}
                data_stream.dataset: {{ .Values.agentConfig.dataStream.dataset }}
                data_stream.namespace: {{ .Values.agentConfig.dataStream.namespace }}
                labels.synthetic: true
                labels.source: windows-synthetic-generator

    agent:
      monitoring:
        enabled: true
        use_output: default
        logs: true
        metrics: true
    {{- end }}
