apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "elastic-agent.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "elastic-agent.labels" . | nindent 4 }}
data:
  agent.yml: |
    {{- if .Values.fleet.enabled }}
    # Fleet-managed mode
    fleet:
      enabled: true
      url: ${FLEET_URL}
      enrollment_token: ${FLEET_ENROLLMENT_TOKEN}
      insecure: ${FLEET_INSECURE}
    {{- else }}
    # Standalone mode
    outputs:
      default:
        type: {{ .Values.agentPolicy.outputs.default.type }}
        hosts:
          - ${ELASTICSEARCH_HOST}
        username: ${ELASTICSEARCH_USERNAME}
        password: ${ELASTICSEARCH_PASSWORD}
        {{- if .Values.elasticsearch.ssl.enabled }}
        ssl:
          enabled: true
          verification_mode: {{ .Values.elasticsearch.ssl.verificationMode }}
          {{- if .Values.elasticsearch.ssl.certificateAuthorities }}
          certificate_authorities:
            - {{ .Values.elasticsearch.ssl.certificateAuthorities }}
          {{- end }}
          {{- if .Values.elasticsearch.ssl.certificate }}
          certificate: {{ .Values.elasticsearch.ssl.certificate }}
          {{- end }}
          {{- if .Values.elasticsearch.ssl.key }}
          key: {{ .Values.elasticsearch.ssl.key }}
          {{- end }}
        {{- end }}

    inputs:
      {{- if .Values.agentPolicy.inputs.system.enabled }}
      # System integration
      {{- if .Values.agentPolicy.inputs.system.metrics.enabled }}
      - type: system/metrics
        id: system-metrics-{{ include "elastic-agent.fullname" . }}
        name: system-metrics
        data_stream:
          namespace: {{ .Values.agentPolicy.namespace }}
        use_output: default
        streams:
          {{- range .Values.agentPolicy.inputs.system.metrics.metricsets }}
          - metricset: {{ . }}
            data_stream:
              dataset: system.{{ . }}
              type: metrics
            period: {{ $.Values.agentPolicy.inputs.system.metrics.period }}
            {{- if eq . "process" }}
            {{- with $.Values.agentPolicy.inputs.system.metrics.process }}
            process.include_top_n:
              {{- toYaml . | nindent 14 }}
            {{- end }}
            {{- end }}
          {{- end }}
      {{- end }}

      {{- if .Values.agentPolicy.inputs.system.logs.enabled }}
      - type: filestream
        id: system-logs-{{ include "elastic-agent.fullname" . }}
        name: system-logs
        data_stream:
          namespace: {{ .Values.agentPolicy.namespace }}
        use_output: default
        streams:
          {{- range .Values.agentPolicy.inputs.system.logs.streams }}
          - id: system-syslog
            data_stream:
              dataset: system.syslog
              type: logs
            paths:
              {{- toYaml .paths | nindent 14 }}
            exclude_files:
              {{- toYaml .exclude_files | nindent 14 }}
          {{- end }}
      {{- end }}
      {{- end }}

    agent:
      monitoring:
        enabled: true
        use_output: default
        logs: true
        metrics: true
    {{- end }}
